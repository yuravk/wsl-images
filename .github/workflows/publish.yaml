name: Publish with Pull Request
on:
  workflow_dispatch:
    inputs:
      almalinux_chat_notiy:
        description: 'Notify AlmaLinux Chat'
        default: true
        type: boolean
      almalinux_chat_channel:
        description: 'Channel name on AlmaLinux Chat'
        default: webhook-testing
        type: string
env:
  # Microsoft WSL repository
  WSL_REPO: yuravk/WSL

jobs:
  create_publishing_pr:
    name: Create publishing PR
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Generate distribution manifest
        run: |
          cat <<'EOF' >> DistributionInfo_generated.json
          {
              "ModernDistributions": {
                  "Ubuntu": [
                      {
                          "Name": "Ubuntu",
                          "FriendlyName": "Ubuntu",
                          "Default": true,
                          "Amd64Url": {
                              "Url": "https://releases.ubuntu.com/24.04.3/ubuntu-24.04.3-wsl-amd64.wsl",
                              "Sha256": "c74833a55e525b1e99e1541509c566bb3e32bdb53bf27ea3347174364a57f47c"
                          },
                          "Arm64Url": {
                              "Url": "https://cdimages.ubuntu.com/releases/24.04.3/release/ubuntu-24.04.3-wsl-arm64.wsl",
                              "Sha256": "edaf375ea0d1319da08e7154e9bc64cd4eead5af21ea032f2edaa335fadf0970"
                          }
                      },
                      {
                          "Name": "Ubuntu-24.04",
                          "FriendlyName": "Ubuntu 24.04 LTS",
                          "Default": false,
                          "Amd64Url": {
                              "Url": "https://releases.ubuntu.com/24.04.3/ubuntu-24.04.3-wsl-amd64.wsl",
                              "Sha256": "c74833a55e525b1e99e1541509c566bb3e32bdb53bf27ea3347174364a57f47c"
                          },
                          "Arm64Url": {
                              "Url": "https://cdimages.ubuntu.com/releases/24.04.3/release/ubuntu-24.04.3-wsl-arm64.wsl",
                              "Sha256": "edaf375ea0d1319da08e7154e9bc64cd4eead5af21ea032f2edaa335fadf0970"
                          }
                      }
                  ],
                  "openSUSE": [
                      {
                          "Name": "openSUSE-Tumbleweed",
                          "FriendlyName": "openSUSE Tumbleweed",
                          "Default": true,
                          "Amd64Url": {
                              "Url": "https://github.com/openSUSE/WSL-instarball/releases/download/v20250923.0/openSUSE-Tumbleweed-20250922.x86_64-22.59-Build22.59.wsl",
                              "Sha256": "0x31124e3645d88b079469a57062af795b04922d3baacfb70c6dad2524c2bfc8c0"
                          },
                          "Arm64Url": {
                              "Url": "https://github.com/openSUSE/WSL-instarball/releases/download/v20250923.0/openSUSE-Tumbleweed-20250922.aarch64-22.124-Build22.124.wsl",
                              "Sha256": "0x0202195a7e03bb45e7ff95e9929b977db899ce85ccaa1195bdab4a74783e9bf7"
                          }
                      },
                      {
                          "Name": "openSUSE-Leap-16.0",
                          "FriendlyName": "openSUSE Leap 16.0",
                          "Default": false,
                          "Amd64Url": {
                              "Url": "https://github.com/openSUSE/WSL-instarball/releases/download/v20251001.0/openSUSE-Leap-16.0-16.0.x86_64-22.57-Build22.57.wsl",
                              "Sha256": "0x0d1faa095153beee0a9b5089b0f9aa3d2aec95e2cdcffdeeff84dd54c48b8393"
                          },
                          "Arm64Url": {
                              "Url": "https://github.com/openSUSE/WSL-instarball/releases/download/v20251001.0/openSUSE-Leap-16.0-16.0.aarch64-22.57-Build22.57.wsl",
                              "Sha256": "0x91bcdc7e9f42d7a60a4464ad867d91243aaaecab7b3a057039f77a989daac51e"
                          }
                      }
                  ],
                  "SUSE": [
                      {
                          "Name": "SUSE-Linux-Enterprise-15-SP6",
                          "FriendlyName": "SUSE Linux Enterprise 15 SP6",
                          "Default": false,
                          "Amd64Url": {
                              "Url": "https://github.com/SUSE/WSL-instarball/releases/download/v20250618.0/SUSE-Linux-Enterprise-15-SP6-15.6.x86_64-23.23-Build23.23.wsl",
                              "Sha256": "0x8f1101972eab1e503993a183e34851920935988f2d5dd1574e336e470101e0e6"
                          }
                      },
                      {
                          "Name": "SUSE-Linux-Enterprise-15-SP7",
                          "FriendlyName": "SUSE Linux Enterprise 15 SP7",
                          "Default": true,
                          "Amd64Url": {
                              "Url": "https://github.com/SUSE/WSL-instarball/releases/download/v20250903.0/SUSE-Linux-Enterprise-15-SP7-15.7.x86_64-27.32-Build27.32.wsl",
                              "Sha256": "0x1e53279af609b9d67b108bc31f1318c3317338595298ef8dfbf7a5728ab8a093"
                          }
                      }
                  ],
                  "kali": [
                      {
                          "Name": "kali-linux",
                          "FriendlyName": "Kali Linux Rolling",
                          "Default": true,
                          "Amd64Url": {
                              "Url": "https://kali.download/wsl-images/kali-2025.3/kali-linux-2025.3-wsl-rootfs-amd64.wsl",
                              "Sha256": "dda0ff3ffe4465cf2af1061262e44cec5a90c1eccb71fe5ccfb1b0fceb5e23a8"
                          },
                          "Arm64Url": {
                              "Url": "https://kali.download/wsl-images/kali-2025.3/kali-linux-2025.3-wsl-rootfs-arm64.wsl",
                              "Sha256": "e175688d9c305b621e701bb11e54f57ac772aed7fa1d94e3f6cb812c1e5e806f"
                          }
                      }
                  ],
                  "Debian": [
                      {
                          "Name": "Debian",
                          "FriendlyName": "Debian GNU/Linux",
                          "Default": true,
                          "Amd64Url": {
                              "Url": "https://salsa.debian.org/debian/WSL/-/jobs/7949331/artifacts/raw/Debian_WSL_AMD64_v1.22.0.0.wsl",
                              "Sha256": "543123ccc5f838e63dac81634fb0223dc8dcaa78fdb981387d625feb1ed168c7"
                          },
                          "Arm64Url": {
                              "Url": "https://salsa.debian.org/debian/WSL/-/jobs/7949331/artifacts/raw/Debian_WSL_ARM64_v1.22.0.0.wsl",
                              "Sha256": "5701f1add55f8cf3b56528109a6220ae5c89f2189d7ae97b9a4b5302b80e967c"
                          }
                      }
                  ],
                  "AlmaLinux": [
                      {
                          "Name": "AlmaLinux-8",
                          "FriendlyName": "AlmaLinux OS 8",
                          "Default": false,
                          "Amd64Url": {
                              "Url": "https://github.com/AlmaLinux/wsl-images/releases/download/v8.10.20250307.0/AlmaLinux-8.10_x64_20250307.0.wsl",
                              "Sha256": "a25b758445d309550dc9bb71dcb87757e378eb2861e78e8817efb4ed9f8ff09e"
                          },
                          "Arm64Url": {
                              "Url": "https://github.com/AlmaLinux/wsl-images/releases/download/v8.10.20250307.0/AlmaLinux-8.10_ARM64_20250307.0.wsl",
                              "Sha256": "0d692a6d23164f91727e2fe57c6bf6ca7162fa9aba0d31abafba48ffad616771"
                          }
                      },
                      {
                          "Name": "AlmaLinux-9",
                          "FriendlyName": "AlmaLinux OS 9",
                          "Default": false,
                          "Amd64Url": {
                              "Url": "https://github.com/AlmaLinux/wsl-images/releases/download/v9.6.20250522.0/AlmaLinux-9.6_x64_20250522.0.wsl",
                              "Sha256": "e0f6acf1ce5aff80f2e60d3d8191c0a3857720149a7e5521b96e11777cdd2779"
                          },
                          "Arm64Url": {
                              "Url": "https://github.com/AlmaLinux/wsl-images/releases/download/v9.6.20250522.0/AlmaLinux-9.6_ARM64_20250522.0.wsl",
                              "Sha256": "58d1cc623c4570307825036460e51a406bdcf53b4b5a4148cf644f5f68ce48dd"
                          }
                      },
                      {
                          "Name": "AlmaLinux-Kitten-10",
                          "FriendlyName": "AlmaLinux OS Kitten 10",
                          "Default": false,
                          "Amd64Url": {
                              "Url": "https://github.com/AlmaLinux/wsl-images/releases/download/v10-kitten.20250415.0/AlmaLinux-Kitten-10_x64_20250415.0.wsl",
                              "Sha256": "8db3788b5728e58e32a4a96d9aa26974a48bf7936ed376da434c5c441a0fa7bd"
                          },
                          "Arm64Url": {
                              "Url": "https://github.com/AlmaLinux/wsl-images/releases/download/v10-kitten.20250415.0/AlmaLinux-Kitten-10_ARM64_20250415.0.wsl",
                              "Sha256": "f48a55e9fd4da1b84c2a9e960a9f3bc6e9fa65387ed9181826e1f052b2ce545e"
                          }
                      },
                      {
                          "Name": "AlmaLinux-10",
                          "FriendlyName": "AlmaLinux OS 10",
                          "Default": true,
                          "Amd64Url": {
                              "Url": "https://github.com/AlmaLinux/wsl-images/releases/download/v10.0.20250529.0/AlmaLinux-10.0_x64_20250529.0.wsl",
                              "Sha256": "6775711048b86743588da7173ab45ca449b5c50a72fb87635313f059a9813d4b"
                          },
                          "Arm64Url": {
                              "Url": "https://github.com/AlmaLinux/wsl-images/releases/download/v10.0.20250529.0/AlmaLinux-10.0_ARM64_20250529.0.wsl",
                              "Sha256": "bc424bd9f954d36e871d4d874d35bc25e3ea7bdfe48337c30b927ed73a79b2fa"
                          }
                      }
                  ],
                  "archlinux": [
                      {
                          "Name": "archlinux",
                          "FriendlyName": "Arch Linux",
                          "Default": true,
                          "Amd64Url": {
                              "Url": "https://geo.mirror.pkgbuild.com/wsl/2025.10.01.148042/archlinux-2025.10.01.148042.wsl",
                              "Sha256": "98a5792935c46476f471854bc93344b2b1d63f7947905ce4dd75d20a546db7ea"
                          }
                      }
                  ],
                  "Fedora": [
                      {
                          "Name": "FedoraLinux-43",
                          "FriendlyName": "Fedora Linux 43",
                          "Default": true,
                          "Amd64Url": {
                              "Url": "https://download.fedoraproject.org/pub/fedora/linux/releases/43/Container/x86_64/images/Fedora-WSL-Base-43-1.6.x86_64.wsl",
                              "Sha256": "220780af9cf225e9645313b4c7b0457a26a38a53285eb203b2ab6188d54d5b82"
                          },
                          "Arm64Url": {
                              "Url": "https://download.fedoraproject.org/pub/fedora/linux/releases/43/Container/aarch64/images/Fedora-WSL-Base-43-1.6.aarch64.wsl",
                              "Sha256": "7eef7a83260218d8c878b3c7bbdaf11772103145184d0c65df27557f4cd49548"
                          }
                      },
                      {
                          "Name": "FedoraLinux-42",
                          "FriendlyName": "Fedora Linux 42",
                          "Default": false,
                          "Amd64Url": {
                              "Url": "https://download.fedoraproject.org/pub/fedora/linux/releases/42/Container/x86_64/images/Fedora-WSL-Base-42-1.1.x86_64.tar.xz",
                              "Sha256": "99fb3d05d78ca17c6815bb03cf528da8ef82ebc6260407f2b09461e0da8a1b8d"
                          },
                          "Arm64Url": {
                              "Url": "https://download.fedoraproject.org/pub/fedora/linux/releases/42/Container/aarch64/images/Fedora-WSL-Base-42-1.1.aarch64.tar.xz",
                              "Sha256": "a5a2ceb8ca56b7245b909d021b0fd620427db349f02b8ef3b82b741bcb5611cd"
                          }
                      }
                  ]
              },
              "Default": "Ubuntu",
              "Distributions": [
                  {
                      "Name": "Ubuntu",
                      "FriendlyName": "Ubuntu",
                      "StoreAppId": "9PDXGNCFSCZV",
                      "Amd64": true,
                      "Arm64": true,
                      "Amd64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/Ubuntu2204-220117.appx",
                      "Arm64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/Ubuntu2204-220117_ARM64.appx",
                      "PackageFamilyName": "CanonicalGroupLimited.Ubuntu_79rhkp1fndgsc"
                  },
                  {
                      "Name": "Debian",
                      "FriendlyName": "Debian GNU/Linux",
                      "StoreAppId": "9MSVKQC78PK6",
                      "Amd64": true,
                      "Arm64": true,
                      "Amd64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/TheDebianProject.DebianGNULinux_1.12.2.0_neutral___76v4gfsz19hv4.AppxBundle",
                      "Arm64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/TheDebianProject.DebianGNULinux_1.12.2.0_neutral___76v4gfsz19hv4.AppxBundle",
                      "PackageFamilyName": "TheDebianProject.DebianGNULinux_76v4gfsz19hv4"
                  },
                  {
                      "Name": "kali-linux",
                      "FriendlyName": "Kali Linux Rolling",
                      "StoreAppId": "9PKR34TNCV07",
                      "Amd64": true,
                      "Arm64": true,
                      "Amd64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/KaliLinux_1.13.1.0.AppxBundle",
                      "Arm64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/KaliLinux_1.13.1.0.AppxBundle",
                      "PackageFamilyName": "KaliLinux.54290C8133FEE_ey8k8hqnwqnmg"
                  },
                  {
                      "Name": "Ubuntu-20.04",
                      "FriendlyName": "Ubuntu 20.04 LTS",
                      "StoreAppId": "9MTTCL66CPXJ",
                      "Amd64": true,
                      "Arm64": true,
                      "Amd64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/Ubuntu2004-230608_x64.appx",
                      "Arm64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/Ubuntu2004-230608_ARM64.appx",
                      "PackageFamilyName": "CanonicalGroupLimited.Ubuntu20.04LTS_79rhkp1fndgsc"
                  },
                  {
                      "Name": "Ubuntu-22.04",
                      "FriendlyName": "Ubuntu 22.04 LTS",
                      "StoreAppId": "9PN20MSR04DW",
                      "Amd64": true,
                      "Arm64": true,
                      "Amd64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/Ubuntu2204LTS-230518_x64.appx",
                      "Arm64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/Ubuntu2204LTS-230518_ARM64.appx",
                      "PackageFamilyName": "CanonicalGroupLimited.Ubuntu22.04LTS_79rhkp1fndgsc"
                  },
                  {
                      "Name": "Ubuntu-24.04",
                      "FriendlyName": "Ubuntu 24.04 LTS",
                      "StoreAppId": "9NZ3KLHXDJP5",
                      "Amd64": true,
                      "Arm64": true,
                      "Amd64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/Ubuntu2404-240425.AppxBundle",
                      "Arm64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/Ubuntu2404-240425.AppxBundle",
                      "PackageFamilyName": "CanonicalGroupLimited.Ubuntu24.04LTS_79rhkp1fndgsc"
                  },
                  {
                      "Name": "OracleLinux_7_9",
                      "FriendlyName": "Oracle Linux 7.9",
                      "StoreAppId": "9P7L0QWBSLTK",
                      "Amd64": true,
                      "Arm64": false,
                      "Amd64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/OracleLinux_7.9-230428.Appx",
                      "Arm64PackageUrl": null,
                      "PackageFamilyName": "3810OracleAmericaInc.OracleLinux7.9_dm28ctvqnhe9g"
                  },
                  {
                      "Name": "OracleLinux_8_10",
                      "FriendlyName": "Oracle Linux 8.10",
                      "StoreAppId": "9MVFWTCT78ZN",
                      "Amd64": true,
                      "Arm64": false,
                      "Amd64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/OracleLinux_8.10-250708.Appx",
                      "Arm64PackageUrl": null,
                      "PackageFamilyName": "3810OracleAmericaInc.OracleLinux8.10_dm28ctvqnhe9g"
                  },
                  {
                      "Name": "OracleLinux_9_5",
                      "FriendlyName": "Oracle Linux 9.5",
                      "StoreAppId": "9NL3F53JZ3HX",
                      "Amd64": true,
                      "Arm64": false,
                      "Amd64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/OracleLinux_9.5-250708.Appx",
                      "Arm64PackageUrl": null,
                      "PackageFamilyName": "3810OracleAmericaInc.OracleLinux9.5_dm28ctvqnhe9g"
                  },
                  {
                      "Name": "openSUSE-Leap-15.6",
                      "FriendlyName": "openSUSE Leap 15.6",
                      "StoreAppId": "9PDTJHBQRQPF",
                      "Amd64": true,
                      "Arm64": true,
                      "Amd64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/openSUSELeap15p6-250320_x64.Appx",
                      "Arm64PackageUrl": "https://publicwsldistros.blob.core.windows.net/wsldistrostorage/openSUSELeap15p6-250320_ARM64.Appx",
                      "PackageFamilyName": "46932SUSE.openSUSELeap15.6_022rs5jcyhyac"
                  },
                  {
                      "Name": "SUSE-Linux-Enterprise-15-SP6",
                      "FriendlyName": "SUSE Linux Enterprise 15 SP6",
                      "StoreAppId": "9N738KZGNB91",
                      "Amd64": true,
                      "Arm64": false,
                      "Amd64PackageUrl": "https://github.com/SUSE/WSL-instarball/releases/download/v20250618.0/SUSE-Linux-Enterprise-15-SP6-15.6-WSL.x86_64-156.3.148.0-Build3.148.appx",
                      "Arm64PackageUrl": null,
                      "PackageFamilyName": "46932SUSE.SUSELinuxEnterprise15SP6_022rs5jcyhyac"
                  },
                  {
                      "Name": "openSUSE-Tumbleweed",
                      "FriendlyName": "openSUSE Tumbleweed",
                      "StoreAppId": "9MSSK2ZXXN11",
                      "Amd64": true,
                      "Arm64": true,
                      "Amd64PackageUrl": "https://github.com/openSUSE/WSL-instarball/releases/download/v20250923.0/openSUSE-Tumbleweed-20250922-WSL.x86_64-25265.9.1077.0-Build9.1077.appx",
                      "Arm64PackageUrl": "https://github.com/openSUSE/WSL-instarball/releases/download/v20250923.0/openSUSE-Tumbleweed-20250922-WSL.aarch64-25265.9.542.0-Build9.542.appx",
                      "PackageFamilyName": "46932SUSE.openSUSETumbleweed_022rs5jcyhyac"
                  }
              ]
          }
          EOF
          # uv run tools/distribution_manifest_updater.py

      - name: Download upstream distribution manifest
        run: curl -LO https://raw.githubusercontent.com/${{ env.WSL_REPO }}/refs/heads/master/distributions/DistributionInfo.json

      - name: Compare distribution manifests
        id: diff_exit_code
        run: |
          trap 'echo "diff_exit_code=$?" >> "$GITHUB_OUTPUT"' EXIT
          git diff --no-index DistributionInfo.json DistributionInfo_generated.json
        continue-on-error: true

      - name: Print DistributionInfo_generated.json
        run: cat DistributionInfo_generated.json

      - name: Checkout WSL repository
        if: ${{ steps.diff_exit_code.outputs.diff_exit_code == '1' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ env.WSL_REPO }}
          path: almalinux_wsl
          token: ${{ secrets.GH_WSL_PAT }}

      - name: Git configure
        if: ${{ steps.diff_exit_code.outputs.diff_exit_code == '1' }}
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
        working-directory: ./almalinux_wsl

      - name: Git add upstream remote
        if: ${{ steps.diff_exit_code.outputs.diff_exit_code == '1' }}
        run: git remote add -f -t master --no-tags microsoft https://github.com/${{ env.WSL_REPO }}.git
        working-directory: ./almalinux_wsl

      - name: Git remove old publishing branch
        if: ${{ steps.diff_exit_code.outputs.diff_exit_code == '1' }}
        run: git push -d origin publishing_pr
        working-directory: ./almalinux_wsl
        continue-on-error: true

      - name: Git create and checkout to publishing branch
        if: ${{ steps.diff_exit_code.outputs.diff_exit_code == '1' }}
        run: git checkout -b publishing_pr microsoft/master
        working-directory: ./almalinux_wsl

      - name: Update distribution manifest
        if: ${{ steps.diff_exit_code.outputs.diff_exit_code == '1' }}
        run: cp -v DistributionInfo_generated.json almalinux_wsl/distributions/DistributionInfo.json

      - name: Run validation
        if: ${{ steps.diff_exit_code.outputs.diff_exit_code == '1' }}
        run: |
          uv run --with-requirements distributions/requirements.txt distributions/validate-modern.py \
              --repo-path . \
              --compare-with-branch microsoft/master \
              --manifest distributions/DistributionInfo.json
        working-directory: ./almalinux_wsl

      - name: Git commit changes
        if: ${{ steps.diff_exit_code.outputs.diff_exit_code == '1' }}
        run: |
          git add ./distributions/DistributionInfo.json
          git commit -m 'chore(distributions): update almalinux'
        working-directory: ./almalinux_wsl

      - name: Git push commit
        if: ${{ steps.diff_exit_code.outputs.diff_exit_code == '1' }}
        run: git push origin publishing_pr
        working-directory: ./almalinux_wsl

      - name: Create a PR
        if: ${{ steps.diff_exit_code.outputs.diff_exit_code == '1' }}
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GH_WSL_PAT }}
        run: |
          echo "pr_url=$(gh pr create --repo ${{ env.WSL_REPO }} --fill-first \
              --assignee $GITHUB_ACTOR \
              --body "This automated release was created by $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID
          Maintainers: @$GITHUB_ACTOR")" >> "$GITHUB_OUTPUT"
        working-directory: ./almalinux_wsl

      - name: Notify
        if: ${{ steps.diff_exit_code.outputs.diff_exit_code == '1' && inputs.almalinux_chat_notiy }}
        uses: mattermost/action-mattermost-notify@2.0.0
        with:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MM_WEBHOOK_URL }}
          MATTERMOST_CHANNEL: ${{ inputs.almalinux_chat_channel }}
          MATTERMOST_USERNAME: 'github'
          TEXT: |
            ##### [PUBLISH]: A submission has been created for the new releases of WSL images
            ###### Pull Request
            :almalinux: ${{ steps.create_pr.outputs.pr_url }}
